<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>查看代码 · View Code</title>
  <meta name="theme-color" content="#0b0c0d" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root{ --bg:#0b0c0d; --panel:#0f1113; --muted:#9aa4ad; --text:#e6eef6; --accent:#48a0ff; --radius:12px; }
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--muted)}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    h1{color:#fff;font-size:20px;margin:0 0 14px;display:flex;align-items:center;gap:8px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,0.08);border-radius:var(--radius);padding:16px;margin-top:16px}
    pre{background:#161a1e;padding:12px;border-radius:8px;overflow:auto;font-size:13px;line-height:1.5;margin:0}
    code{font-family:Menlo,monospace}
    .muted{color:#7e8b97}
    .err{color:#ff6b6b}
    .ok{color:#56d364}
    a.btn,button.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;text-decoration:none;border:1px solid rgba(255,255,255,0.08);background:var(--panel);color:var(--text);cursor:pointer}
    a.btn.primary{background:var(--accent);color:#071022;border:0}
    .meta-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;font-size:12px;margin-top:12px}
    .kv{background:#161a1e;padding:8px;border-radius:8px}
    .kv b{display:block;color:#fff;font-weight:600;margin-bottom:4px;font-size:11px;opacity:.85}
  </style>
</head>
<body>
  <div class="wrap">
    <h1><i class="fas fa-eye"></i> 查看代码 · View Code</h1>
    <div class="card" id="statusCard">
      <div id="status" class="muted">解析中 / Loading…</div>
      <div id="meta" class="meta-grid" style="display:none"></div>
    </div>
    <div class="card">
      <h2 style="margin:0 0 10px;color:#fff;font-size:16px">源码 · Source</h2>
      <pre><code id="codeArea">(暂无数据 / No data)</code></pre>
    </div>
  </div>
<script>
(function(){
  function getParam(name){ const u=new URL(location.href); return u.searchParams.get(name); }
  const repoPath = getParam('path'); // e.g. submissions/week-1/<handle>/solution.c
  const repo = getParam('repo')||'';
  const branch = getParam('branch')||'main';
  const statusEl=document.getElementById('status');
  const codeEl=document.getElementById('codeArea');
  const metaGrid=document.getElementById('meta');

  if(!repoPath){ statusEl.className='err'; statusEl.textContent='缺少 path 参数 / Missing path'; return; }

  async function load(){
    try{
      // viewer 位于 competition/ 目录下，需要向上一级取仓库根目录的文件
      const res = await fetch('../'+repoPath, {cache:'no-store'});
      if(!res.ok){ throw new Error('HTTP '+res.status); }
      const text = await res.text();
      // Try JSON encrypted (v3)
      let parsed=null, code=null, meta=null;
      try{ parsed = JSON.parse(text); }catch(_){ }
      if(parsed && parsed.type==='contest' && parsed.version===3 && parsed.encCode && parsed.key){
        if(!/^([0-9a-fA-F]{2})+$/.test(parsed.key) || !/^([0-9a-fA-F]{2})+$/.test(parsed.encCode)) throw new Error('Bad hex payload');
        const toBytes = h=>{ const a=new Uint8Array(h.length/2); for(let i=0;i<a.length;i++) a[i]=parseInt(h.substr(i*2,2),16); return a; };
        const keyBytes=toBytes(parsed.key); const encCode=toBytes(parsed.encCode); const out=new Uint8Array(encCode.length);
        for(let i=0;i<encCode.length;i++) out[i]=encCode[i]^keyBytes[i%keyBytes.length];
        code = new TextDecoder().decode(out);
        // decrypt metadata if present
        if(parsed.enc){
          try{
            const encMeta = toBytes(parsed.enc); const metaOut=new Uint8Array(encMeta.length);
            for(let i=0;i<encMeta.length;i++) metaOut[i]=encMeta[i]^keyBytes[i%keyBytes.length];
            meta = JSON.parse(new TextDecoder().decode(metaOut));
          }catch(_){ meta=null; }
        }
      }
      if(!code){
        // treat as plaintext fallback
        code = text;
      }
      codeEl.textContent=code;
      statusEl.className='ok';
      statusEl.textContent='加载完成 / Loaded';
      // meta display
      metaGrid.innerHTML='';
      const items=[];
      if(meta && meta.handle) items.push(['Handle', meta.handle]);
      if(meta && meta.challenge) items.push(['Challenge', meta.challenge]);
      if(meta && meta.bytes) items.push(['Bytes', String(meta.bytes)]);
      if(meta && meta.ts) items.push(['Timestamp', meta.ts]);
      items.push(['File Path', repoPath]);
      if(repo) items.push(['Repo', repo]);
      items.push(['Branch', branch]);
      items.forEach(([k,v])=>{ const div=document.createElement('div'); div.className='kv'; div.innerHTML='<b>'+k+'</b><span>'+v+'</span>'; metaGrid.appendChild(div); });
      if(items.length){ metaGrid.style.display='grid'; }
    }catch(e){ statusEl.className='err'; statusEl.textContent='加载或解析失败：'+(e&&e.message||e); }
  }
  load();
})();
</script>
</body>
</html>
