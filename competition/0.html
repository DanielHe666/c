<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="title">Round <id> · 第 <id> 期</title>
  <meta name="theme-color" content="#0b0c0d" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root{ --bg:#0b0c0d; --panel:#0f1113; --muted:#9aa4ad; --text:#e6eef6; --accent:#48a0ff; --radius:12px; }
    body{margin:0;background:var(--bg);color:var(--muted);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between}
    header h1{color:#fff;font-size:22px;margin:0;display:flex;align-items:center;gap:8px}
    a.btn,button.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:10px;text-decoration:none;border:1px solid rgba(255,255,255,0.08);background:var(--panel);color:var(--text);cursor:pointer}
    a.btn.primary,button.btn.primary{background:var(--accent);color:#071022;border:0}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,0.08);border-radius:var(--radius);padding:18px;margin-top:18px}
    .card h2{margin:0 0 12px;color:#fff;font-size:20px}
    pre{background:#161a1e;padding:12px;border-radius:10px;overflow:auto;font-size:13px;line-height:1.5}
    code{font-family:Menlo,monospace}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px}
    th,td{border:1px solid #222;padding:6px 8px;text-align:left}
    th{background:#161a1e;color:#fff}
    .footer{margin-top:26px;display:flex;justify-content:space-between;align-items:center;font-size:12px}
    .notice{background:#161a1e;padding:10px;border-radius:8px;font-size:13px;line-height:1.6}
  /* diff feedback styles */
  .diff-block pre{max-height:260px}
  .fail{color:#ff6b6b}
  .ok{color:#56d364}
  .warn{color:#ffb020}
  .muted{color:#9aa4ad}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="h1"><i class="fas fa-calendar-week"></i> Round <span id="rid"></span> · 第 <span id="rid2"></span> 期 <span id="diffTag" style="font-size:12px;color:#9aa4ad;font-weight:400;margin-left:8px"></span></h1>
      <div class="row" style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="./index.html"><i class="fas fa-list"></i> 返回列表 List</a>
        <a id="rankBtn" class="btn" href="#"><i class="fas fa-medal"></i> 榜单 Board</a>
        <a class="btn" href="./rank/index.html"><i class="fas fa-ranking-star"></i> 天梯榜 Ladder</a>
        <button id="langBtn" class="btn"><i class="fas fa-globe"></i> EN</button>
      </div>
    </header>

    <div class="card">
      <h2 id="problemTitle"><span id="pid"></span>. 题目标题</h2>
      <p id="problemDesc">在这里填写题目描述（可中英文）。你也可以从 problems.json 中读取 desc 字段。</p>
      <h3 id="inputFormatTitle">输入格式</h3>
      <p id="inputFormatDesc">请在这里写输入格式。</p>
      <h3 id="outputFormatTitle">输出格式</h3>
      <p id="outputFormatDesc">请在这里写输出格式。</p>
      <h3 id="samplesTitle">样例</h3>
      <pre style="display:none"><code id="sampleIn1"></code></pre>
      <pre style="display:none"><code id="sampleOut1"></code></pre>
    </div>

    <div class="card" id="submitCard">
      <h2><i class="fas fa-paper-plane"></i> 直接在此提交 · Submit Here</h2>
      <div class="row" style="margin:10px 0;gap:10px;align-items:center">
        <label for="handleInput">昵称 Handle</label>
        <input id="handleInput" type="text" placeholder="你的昵称（可含空格，不可含/\\）" style="flex:1;min-width:220px"/>
        <button id="saveHandleBtn" class="btn"><i class="fas fa-user-check"></i> 保存昵称</button>
      </div>
      <textarea id="codeInput" placeholder="在此粘贴你的 C 代码..." style="width:100%;min-height:240px;background:#161a1e;border:1px solid #222;border-radius:8px;color:#e6eef6;padding:10px 12px;font-family:Menlo,monospace;font-size:13px"></textarea>
      <div class="row" style="margin-top:8px;gap:10px;flex-wrap:wrap">
        <button id="judgeBtn" class="btn primary"><i class="fas fa-vial"></i> 评测代码</button>
        <button id="genPayloadBtn" class="btn" style="display:none;background:#2ea043;border:0;color:#071022"><i class="fas fa-shield-halved"></i> 生成密文</button>
        <a id="roundRankBtn" class="btn" href="#" target="_blank" rel="noreferrer"><i class="fas fa-medal"></i> 查看本期排行榜</a>
        <a id="submitPageBtn" class="btn" href="./submit.html" target="_blank" rel="noreferrer" style="display:none"><i class="fas fa-share-from-square"></i> 提交页（粘贴密文）</a>
      </div>
      <div id="submitStatus" class="muted" style="margin-top:8px"></div>
  <div id="judgeDiff" class="diff-block" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h2>提交 & 规则</h2>
      <ul style="line-height:1.7;margin:0 0 10px;padding-left:18px">
        <li>按最小字节数排序；相同按提交先后。</li>
        <li>天梯积分：难度积分 D；第一名 D，其他 round(D × 最小字节数/自身字节数)。</li>
        <li>仅统计单个 .c，需可在 Wandbox(gcc) 编译运行。</li>
        <li>禁止 UB、文件 I/O、非标准库。</li>
        <li>UTF-8 字节数计数。</li>
      </ul>
      <div class="notice">
        提交方式：Fork 本仓库 → 在 <code>submissions/<id>/<你的昵称>/solution.c</code>（兼容 <code>submissions/week-<id>/</code>）添加/覆盖 → 发 PR。
      </div>
    </div>

    <div class="footer">
      <div>By C. He · Online C Compiler</div>
      <a class="btn" href="../about.html"><i class="fas fa-circle-info"></i> 关于 About</a>
    </div>
  </div>
  <script src="../scripts/version.js"></script>
  <script src="../scripts/contest_submit.js"></script>
  <script>
    function currentId(){
      const m = location.pathname.match(/(\d+)\.html$/); return m? parseInt(m[1],10): 1;
    }
    async function loadMeta(id){
      try{ const res=await fetch('./problems.json?fresh='+(Date.now()),{cache:'no-store'}); if(!res.ok) return null; const arr=await res.json(); return (arr||[]).find(x=>x.id===id)||null; }catch(e){ return null; }
    }
    function setText(id, meta){
      const lang = localStorage.getItem('ui_lang') || 'zh';
      document.getElementById('rid').textContent=id; document.getElementById('rid2').textContent=id; document.getElementById('pid').textContent=id;
      const name = lang ==='zh'? (meta?.title || `第 ${id} 期`) : (meta?.title || `Round ${id}`);
      document.getElementById('title').textContent = `${name} · Round ${id}`;
      document.getElementById('problemTitle').textContent = `${id}. ${name}`;
      if(meta?.difficulty){ document.getElementById('diffTag').textContent = `D=${meta.difficulty}`; }
      
      const desc = lang === 'zh' ? (meta?.desc_zh || meta?.desc_en) : (meta?.desc_en || meta?.desc_zh);
      // Use a markdown parser if available, otherwise just set textContent
      document.getElementById('problemDesc').textContent = desc || '题目描述加载失败。Failed to load description.';

      // Hide empty sections
      if (!meta?.desc_zh && !meta?.desc_en) document.getElementById('problemDesc').parentElement.style.display = 'none';
      document.getElementById('inputFormatTitle').style.display = 'none';
      document.getElementById('inputFormatDesc').style.display = 'none';
      document.getElementById('outputFormatTitle').style.display = 'none';
      document.getElementById('outputFormatDesc').style.display = 'none';
      document.getElementById('samplesTitle').style.display = 'none';

  const rb=document.getElementById('rankBtn'); const rrb=document.getElementById('roundRankBtn');
  if(rb) rb.href = `./rank/board.html?id=${id}`;
  if(rrb) rrb.href = `./rank/board.html?id=${id}`;
    }

  // —— 评测逻辑（新版统一 diff 输出） ——
    async function tryWandbox(code, stdin){
      const wandboxUrl='https://wandbox.org/api/compile.json';
      const payload={ code, compiler:'gcc-head', stdin: stdin||undefined, save:false };
      const res = await fetch(wandboxUrl,{method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)});
      if(!res.ok) throw new Error('wandbox '+res.status);
      const j=await res.json();
      const out=(j.program_output||j.program_stdout||j.program||j.result||'')||'';
      return out.replace(/\n+$/,'');
    }
    async function loadTests(pid){
      function synthDiamondTests(){
        function gen(n){ const lines=[]; const mid=(n-1)/2; for(let r=0;r<n;r++){ const dist=Math.abs(mid-r); const stars=n-2*dist; const spaces=dist; lines.push(' '.repeat(spaces)+'*'.repeat(stars)); } return lines.join('\n'); }
        return [1,3,5,7,9].map(n=>({stdin:String(n)+'\n', expected: gen(n)}));
      }
      let tests=[];
      try{ const r1=await fetch(`./data/tests/prob-${pid}.json`,{cache:'no-store'}); if(r1.ok){ tests=await r1.json(); } }catch(e){ }
      if((!Array.isArray(tests) || !tests.length)){
        try{ const r2=await fetch(`./data/tests/week-${pid}.json`,{cache:'no-store'}); if(r2.ok){ tests=await r2.json(); } }catch(e){ }
      }
      if((!Array.isArray(tests) || !tests.length) && pid===1){ tests = synthDiamondTests(); }
      return Array.isArray(tests)? tests: [];
    }
    function visualize(str){ return String(str||'').replace(/ /g,'·'); }
    async function judgeWithDiff(id, source){
      const tests = await loadTests(id);
      if(!tests.length) return {pass:false, reason:'无测试集', cases:[]};
      const cases=[];
      for(let i=0;i<tests.length;i++){
        const tc=tests[i];
        const exp=(tc.expect||tc.expected||'').replace(/\n+$/,'');
        const out=await tryWandbox(source, tc.stdin||'');
        const ok=out===exp;
        cases.push({index:i, stdin:tc.stdin||'', expected:exp, output:out, pass:ok});
        if(!ok) return {pass:false, failedIndex:i, cases};
      }
      return {pass:true, cases};
    }

    (function(){
      const id=currentId();
      loadMeta(id).then(meta=>setText(id, meta));
      const handleInput=document.getElementById('handleInput');
      const saveHandleBtn=document.getElementById('saveHandleBtn');
      const codeInput=document.getElementById('codeInput');
      const judgeBtn=document.getElementById('judgeBtn');
      const genBtn=document.getElementById('genPayloadBtn');
      const submitPageBtn=document.getElementById('submitPageBtn');
  const statusEl=document.getElementById('submitStatus');
  const diffEl=document.getElementById('judgeDiff');
      try{ const h=window.__ContestSubmit.getHandle(); if(h) handleInput.value=h; }catch(_){ }
      saveHandleBtn.addEventListener('click',()=>{ const raw=(handleInput.value||'').trim(); if(!raw){ alert('昵称不能为空'); return; } window.__ContestSubmit.setProfile({handle:raw}); });
      judgeBtn.addEventListener('click', async ()=>{
        const handleRaw=(handleInput.value||'').trim(); if(!handleRaw){ alert('请先填写昵称'); return; }
        window.__ContestSubmit.setProfile({handle:handleRaw});
        const source=codeInput.value||''; if(!source.trim()){ alert('请粘贴代码'); return; }
        statusEl.className='muted'; statusEl.textContent='评测中 / Judging...'; diffEl.innerHTML=''; genBtn.style.display='none'; submitPageBtn.style.display='none';
        try{
          const result=await judgeWithDiff(id, source);
          if(!result.pass){
            statusEl.className='fail'; statusEl.textContent='未通过 / Failed。';
            if(result.reason){ diffEl.innerHTML='<div class="fail">'+result.reason+'</div>'; return; }
            const f=result.cases[result.failedIndex];
            diffEl.innerHTML=`<div class="fail">失败用例 #${f.index+1}</div>`+
              `<pre><code>stdin:\n${visualize(f.stdin.replace(/\n$/,''))}</code></pre>`+
              `<pre><code>expected:\n${visualize(f.expected)}</code></pre>`+
              `<pre><code>output:\n${visualize(f.output)}</code></pre>`;
            return;
          }
          statusEl.className='ok'; statusEl.textContent='通过 | Accepted。可以生成密文。';
          genBtn.style.display='inline-flex'; submitPageBtn.style.display='inline-flex'; genBtn.focus();
        }catch(e){ statusEl.className='warn'; statusEl.textContent='评测失败：'+(e&&e.message||e); }
      });
      genBtn.addEventListener('click', async ()=>{
        const source=codeInput.value||''; if(!source.trim()){ alert('代码为空'); return; }
  genBtn.disabled=true; const old=genBtn.innerHTML; genBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> 生成中';
  statusEl.className='muted'; statusEl.textContent='生成密文中...';
        try{
          const payload = await window.__ContestSubmit.buildPayload(String(id), source);
          const slim = payload.version===3 ? { type:'contest', version:3, challenge: payload.challenge, enc: payload.enc, encCode: payload.encCode, key: payload.key } : payload;
          const jsonStr = JSON.stringify(slim, null, 2);
          try{ window.__LAST_SUBMISSION_JSON = jsonStr; }catch(_){ }
          const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
          const url = './submit.html#submission='+b64;
          let copied=false; try{ await navigator.clipboard.writeText(jsonStr); copied=true; }catch(_){ }
          const copiedTip = copied ? '（已自动复制到剪贴板）' : '（复制失败，请手动复制下方 JSON）';
          statusEl.innerHTML='✅ 已生成密文 '+copiedTip+'。<br>1) 打开提交页。<br>2) 在 Fork 里新建/覆盖 solution.c 粘贴下列 JSON：<br><pre style="background:#161a1e;padding:10px;border-radius:8px;overflow:auto;font-size:12px"><code>'+jsonStr.replace(/[&<>]/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[s]))+'</code></pre>';
          const a=document.createElement('a'); a.href=url; a.target='_blank'; a.rel='noreferrer'; a.textContent='打开提交页（新标签）'; a.className='btn'; a.style.marginTop='8px'; statusEl.appendChild(a);
          submitPageBtn.onclick = async ()=>{ if(window.__LAST_SUBMISSION_JSON){ try{ await navigator.clipboard.writeText(window.__LAST_SUBMISSION_JSON); }catch(_){ } } };
  }catch(e){ statusEl.className='fail'; statusEl.textContent='生成密文失败：'+(e&&e.message||e); }
        finally{ genBtn.disabled=false; genBtn.innerHTML=old; }
      });
    })();
  </script>
</body>
</html>
