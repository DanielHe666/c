<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Round 1 · 第 1 期</title>
  <meta name="theme-color" content="#0b0c0d" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root{ --bg:#0b0c0d; --panel:#0f1113; --muted:#9aa4ad; --text:#e6eef6; --accent:#48a0ff; --radius:12px; }
    body{margin:0;background:var(--bg);color:var(--muted);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial}
    .wrap{max-width:860px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap}
    header h1{color:#fff;font-size:22px;margin:0;display:flex;align-items:center;gap:8px}
    a.btn,button.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:10px;text-decoration:none;border:1px solid rgba(255,255,255,0.08);background:var(--panel);color:var(--text);cursor:pointer;font-size:13px}
    a.btn.primary,button.btn.primary{background:var(--accent);color:#071022;border:0}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,0.08);border-radius:var(--radius);padding:18px;margin-top:18px}
    .card h2{margin:0 0 12px;color:#fff;font-size:19px}
    textarea{width:100%;min-height:240px;background:#161a1e;border:1px solid #222;border-radius:8px;color:#e6eef6;padding:10px 12px;font-family:Menlo,monospace;font-size:13px;resize:vertical}
    pre{background:#161a1e;padding:10px 12px;border-radius:8px;overflow:auto;font-size:12px;line-height:1.5;margin:8px 0}
    code{font-family:Menlo,monospace}
    .diff-block pre{max-height:260px}
    .notice{background:#161a1e;padding:10px;border-radius:8px;font-size:12px;line-height:1.6}
    .fail{color:#ff6b6b}
    .ok{color:#56d364}
    .warn{color:#ffb020}
    .muted{color:#9aa4ad;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1><i class="fas fa-calendar-week"></i> Round 1 · 第 1 期 <span id="diffTag" style="font-size:12px;color:#9aa4ad;font-weight:400;margin-left:8px"></span></h1>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn" href="./index.html"><i class="fas fa-list"></i> 列表</a>
  <a id="rankBtn" class="btn" href="./rank/board.html?id=1"><i class="fas fa-medal"></i> 榜单</a>
        <a class="btn" href="./rank/index.html"><i class="fas fa-ranking-star"></i> 天梯</a>
      </div>
    </header>

    <div class="card" id="problemCard">
      <h2>1. 打印菱形图案</h2>
      <p>读取一个正奇数 n (1 ≤ n ≤ 99)，输出由星号组成的对称菱形。每行无尾随空格，最后一行后需换行。</p>
    <p class="muted">示例 (n=5)：</p>
    <pre><code>  *
 ***
*****
 ***
  *</code></pre>
    </div>

    <div class="card" id="submitCard">
      <h2><i class="fas fa-paper-plane"></i> 提交 / Submit</h2>
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
        <label for="handleInput" style="font-size:13px">昵称 Handle</label>
        <input id="handleInput" type="text" placeholder="你的昵称（可含空格，不可含/\\）" style="flex:1;min-width:220px;padding:6px 10px;border-radius:8px;border:1px solid #222;background:#161a1e;color:#e6eef6;font-size:13px" />
        <button id="saveHandleBtn" class="btn"><i class="fas fa-user-check"></i> 保存</button>
      </div>
      <textarea id="codeInput" placeholder="粘贴你的 C 代码..."></textarea>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
        <button id="judgeBtn" class="btn primary"><i class="fas fa-vial"></i> 评测</button>
        <button id="genPayloadBtn" class="btn" style="display:none;background:#2ea043;border:0;color:#071022"><i class="fas fa-shield-halved"></i> 生成密文</button>
        <a id="submitPageBtn" class="btn" href="./submit.html" target="_blank" rel="noreferrer" style="display:none"><i class="fas fa-share-from-square"></i> 提交页</a>
      </div>
      <div id="submitStatus" class="muted" style="margin-top:8px"></div>
      <div id="judgeDiff" class="diff-block" style="margin-top:10px"></div>
    </div>

    <div class="card" id="rulesCard">
      <h2>规则 / Rules</h2>
      <ul style="line-height:1.7;margin:0 0 10px;padding-left:18px;font-size:13px">
        <li>按最小字节数排序；相同按提交先后。</li>
        <li>难度积分 D：第一名记 D，其他 round(D × 最小字节数 / 自身字节数)。</li>
        <li>仅统计单个 .c，可在 Wandbox(gcc) 编译运行。</li>
        <li>禁止 UB、文件 IO、非标准库。</li>
        <li>UTF-8 字节数计数。</li>
      </ul>
      <div class="notice">提交方式：Fork 仓库 → 在 <code>submissions/1/&lt;昵称&gt;/solution.c</code> （兼容 <code>submissions/week-1/</code>）添加/覆盖 → 发 PR。</div>
    </div>
  </div>

  <script src="../scripts/version.js"></script>
  <script src="../scripts/contest_submit.js"></script>
  <script>
    const PROBLEM_ID = 1;
    // --- Helpers ---
    function genDiamond(n){ const lines=[]; const mid=(n-1)/2; for(let r=0;r<n;r++){ const dist=Math.abs(mid-r); const stars=n-2*dist; const spaces=dist; lines.push(' '.repeat(spaces)+'*'.repeat(stars)); } return lines.join('\n'); }
    async function tryWandbox(code, stdin){
      const wandboxUrl='https://wandbox.org/api/compile.json';
      const payload={ code, compiler:'gcc-head', stdin: stdin||undefined, save:false };
      const res=await fetch(wandboxUrl,{method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)});
      if(!res.ok) throw new Error('wandbox '+res.status);
      const j=await res.json();
      const out=(j.program_output||j.program_stdout||j.program||j.result||'')||'';
      return out.replace(/\n+$/,'');
    }
    async function loadTests(id){
      let tests=[];
      try{ const r1=await fetch(`./data/tests/prob-${id}.json`,{cache:'no-store'}); if(r1.ok) tests=await r1.json(); }catch(e){ }
      if((!Array.isArray(tests)||!tests.length)){
        try{ const r2=await fetch(`./data/tests/week-${id}.json`,{cache:'no-store'}); if(r2.ok) tests=await r2.json(); }catch(e){ }
      }
      if((!Array.isArray(tests)||!tests.length) && id===1){ tests=[1,3,5,7,9].map(n=>({stdin:String(n)+'\n', expected: genDiamond(n)})); }
      return Array.isArray(tests)? tests: [];
    }
    function visualize(str){
      return str.replace(/ /g,'·'); // spaces -> middot
    }
    async function judgeWithDiff(id, src){
      const tests=await loadTests(id);
      if(!tests.length) return {pass:false, reason:'无测试集', cases:[]};
      const cases=[];
      for(let i=0;i<tests.length;i++){
        const tc=tests[i];
        const exp=(tc.expect||tc.expected||'').replace(/\n+$/,'');
        const out=await tryWandbox(src, tc.stdin||'');
        const ok = out===exp;
        cases.push({index:i, stdin:tc.stdin||'', expected:exp, output:out, pass:ok});
        if(!ok){ return {pass:false, failedIndex:i, cases}; }
      }
      return {pass:true, cases};
    }

    // --- UI Logic ---
    (function(){
      const handleInput=document.getElementById('handleInput');
      const saveHandleBtn=document.getElementById('saveHandleBtn');
      const codeInput=document.getElementById('codeInput');
      const judgeBtn=document.getElementById('judgeBtn');
      const genBtn=document.getElementById('genPayloadBtn');
      const submitPageBtn=document.getElementById('submitPageBtn');
      const statusEl=document.getElementById('submitStatus');
      const diffEl=document.getElementById('judgeDiff');
      try{ const h=window.__ContestSubmit.getHandle(); if(h) handleInput.value=h; }catch(_){ }
      saveHandleBtn.addEventListener('click',()=>{ const raw=(handleInput.value||'').trim(); if(!raw){ alert('昵称不能为空'); return; } window.__ContestSubmit.setProfile({handle:raw}); saveHandleBtn.innerHTML='<i class="fas fa-check"></i> 已保存'; setTimeout(()=> saveHandleBtn.innerHTML='<i class="fas fa-user-check"></i> 保存', 1200); });
      judgeBtn.addEventListener('click', async ()=>{
        const handleRaw=(handleInput.value||'').trim(); if(!handleRaw){ alert('请先填写昵称'); return; }
        window.__ContestSubmit.setProfile({handle:handleRaw});
        const source=codeInput.value||''; if(!source.trim()){ alert('请粘贴代码'); return; }
        statusEl.className='muted'; statusEl.textContent='评测中 / Judging...'; statusEl.style.color=''; diffEl.innerHTML=''; genBtn.style.display='none'; submitPageBtn.style.display='none';
        try{
          const result = await judgeWithDiff(PROBLEM_ID, source);
          if(!result.pass){
            statusEl.className='fail'; statusEl.textContent='未通过 / Failed。';
            if(result.reason){ diffEl.innerHTML='<div class="fail">'+result.reason+'</div>'; return; }
            const f = result.cases[result.failedIndex];
            const html = `
              <div class="fail">失败用例 #${f.index+1}</div>
              <pre><code>stdin:\n${visualize(f.stdin.replace(/\n$/,''))}</code></pre>
              <pre><code>expected:\n${visualize(f.expected)}</code></pre>
              <pre><code>output:\n${visualize(f.output)}</code></pre>
            `;
            diffEl.innerHTML=html;
            return;
          }
          statusEl.className='ok'; statusEl.textContent='通过 | Accepted。可以生成密文。';
          genBtn.style.display='inline-flex'; submitPageBtn.style.display='inline-flex'; genBtn.focus();
        }catch(e){ statusEl.className='warn'; statusEl.textContent='评测异常：'+(e&&e.message||e); }
      });
      genBtn.addEventListener('click', async ()=>{
        const source=codeInput.value||''; if(!source.trim()){ alert('代码为空'); return; }
        genBtn.disabled=true; const old=genBtn.innerHTML; genBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> 生成中'; statusEl.className='muted'; statusEl.textContent='生成密文中...';
        try{
          const payload=await window.__ContestSubmit.buildPayload(String(PROBLEM_ID), source);
          const slim=payload.version===3?{ type:'contest', version:3, challenge: payload.challenge, enc: payload.enc, encCode: payload.encCode, key: payload.key }:payload;
          const jsonStr=JSON.stringify(slim,null,2);
          try{ window.__LAST_SUBMISSION_JSON=jsonStr; }catch(_){ }
          let copied=false; try{ await navigator.clipboard.writeText(jsonStr); copied=true; }catch(_){ }
          const copiedTip=copied?'（已复制）':'（自动复制失败，请手动）';
          statusEl.className='ok'; statusEl.innerHTML='✅ 密文生成 '+copiedTip+'：<pre><code>'+jsonStr.replace(/[&<>]/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[s]))+'</code></pre>';
          submitPageBtn.onclick=async()=>{ if(window.__LAST_SUBMISSION_JSON){ try{ await navigator.clipboard.writeText(window.__LAST_SUBMISSION_JSON); }catch(_){ } } };
          submitPageBtn.style.display='inline-flex';
        }catch(e){ statusEl.className='fail'; statusEl.textContent='生成失败：'+(e&&e.message||e); }
        finally{ genBtn.disabled=false; genBtn.innerHTML=old; }
      });
    })();
  </script>
</body>
</html>
