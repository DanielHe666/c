<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>提交参赛 · Submit Contest</title>
  <meta name="theme-color" content="#0b0c0d" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root{ --bg:#0b0c0d; --panel:#0f1113; --muted:#9aa4ad; --text:#e6eef6; --accent:#48a0ff; --radius:12px; }
    body{margin:0;background:var(--bg);color:var(--muted);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;gap:10px;justify-content:space-between}
    header h1{color:#fff;font-size:20px;margin:0;display:flex;align-items:center;gap:8px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,0.08);border-radius:var(--radius);padding:16px;margin-top:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    a.btn,button.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;text-decoration:none;border:1px solid rgba(255,255,255,0.08);background:var(--panel);color:var(--text);cursor:pointer}
    a.btn.primary,button.btn.primary{background:var(--accent);color:#071022;border:0}
    textarea{width:100%;min-height:260px;background:#161a1e;border:1px solid #222;border-radius:8px;color:#e6eef6;padding:10px 12px;font-family:Menlo,monospace;font-size:13px}
    .muted{color:#7e8b97}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
  <h1><i class="fas fa-paper-plane"></i> 提交参赛 · Submit Contest (Round)</h1>
      <div class="row">
  <a class="btn" href="../index.html"><i class="fas fa-flag-checkered"></i> C Code Golf</a>
        <a class="btn" href="../../index.html"><i class="fas fa-code"></i> 编辑器 Editor</a>
        <a class="btn primary" href="../submission_guide/index.html" target="_blank" rel="noreferrer"><i class="fas fa-book"></i> 教程 Tutorial</a>
      </div>
    </header>

    <div class="card">
      <div id="summary" class="muted">解析提交中…</div>
      <div id="meta" class="muted" style="margin-top:6px"></div>
      <div id="pathInfo" class="muted" style="margin-top:6px"></div>
      <div class="row" style="margin-top:8px">
        <button id="copyBtn" class="btn"><i class="fas fa-copy"></i> 复制密文 Copy Encrypted</button>
        <button id="pasteBtn" class="btn"><i class="fas fa-clipboard"></i> 自动粘贴密文 Auto Paste</button>
        <a id="forkBtn" class="btn" target="_blank" rel="noreferrer"><i class="fas fa-code-fork"></i> Fork 仓库 Fork Repo</a>
        <a id="openGh" class="btn" target="_blank" rel="noreferrer"><i class="fas fa-file-circle-plus"></i> 在 Fork 中建文件 New File in Fork</a>
        <a id="issueBtn" class="btn primary" target="_blank" rel="noreferrer"><i class="fas fa-exclamation-circle"></i> 备用：Issue 提交 Alt: Issue</a>
        <button id="editHandleBtn" class="btn" type="button"><i class="fas fa-user-edit"></i> 修改昵称 Edit Handle</button>
      </div>
      <textarea id="code"></textarea>
      <div class="muted" style="margin-top:8px" id="flowTips">
        标准流程（推荐 Fork + PR）:<br>
        1) 点击 Fork（若已 Fork 可忽略）。<br>
  2) 在你的 Fork 仓库中新建文件路径：<code>submissions/&lt;n&gt;/&lt;handle&gt;/solution.c</code>（兼容旧路径 <code>submissions/week-&lt;n&gt;/</code>）。<br>
        3) 将本页下方“密文/内容”粘贴进去保存（可点“复制密文”，或点“自动粘贴密文”将剪贴板内容填入文本框）。<br>
  4) 发起 Pull Request 回主仓库（ChenyuHeee/c）。合并后脚本会重新计算本轮与天梯积分。<br>
        备用流程：无法方便地发 PR 时，使用“Issue 提交”，自动生成包含加密字段的 Issue；管理员稍后手动归档。<br>
        提示：此页面不具备直接写入主仓库权限——参赛者需在个人 Fork 中完成提交。
      </div>
    </div>
  </div>
  <script>
    function decodeBase64(b64){
      try{
        const bin=atob(b64); const bytes=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
        return new TextDecoder().decode(bytes);
      }catch(e){ return decodeURIComponent(escape(atob(b64))); }
    }
  function parseWeek(code){
    if(code==null) return null;
    const s=String(code).trim();
    const m=s.match(/week-(\d+)/i);
    if(m) return parseInt(m[1],10);
    if(/^\d+$/.test(s)) return parseInt(s,10);
    return null;
  }
  function fromHex(h){ const arr=new Uint8Array(h.length/2); for(let i=0;i<arr.length;i++){ arr[i]=parseInt(h.substr(i*2,2),16); } return arr; }
  function xorBytes(a,b){ const out=new Uint8Array(a.length); for(let i=0;i<a.length;i++){ out[i]=a[i]^b[i%b.length]; } return out; }
  function toHex(buf){ return Array.from(buf).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  // 允许空格的目录名：仅禁止 / 与 \\，并去除首尾空格；将连续空白折叠为单个空格
  function toPathHandle(s){ return String(s||'').replace(/[\\/]/g,'-').trim().replace(/\s+/g,' '); }
  const OWNER='ChenyuHeee';
  const REPO='c';
    (function(){
      const summaryEl = document.getElementById('summary');
      const metaEl = document.getElementById('meta');
      const pathInfoEl = document.getElementById('pathInfo');
      const codeEl = document.getElementById('code');
      const copyBtnCode = document.getElementById('copyBtn');
      const pasteBtn = document.getElementById('pasteBtn');
      const forkBtn = document.getElementById('forkBtn');
      const openGhBtn = document.getElementById('openGh');
      const issueBtn = document.getElementById('issueBtn');
      const editBtn = document.getElementById('editHandleBtn');
      // 预设 Fork 链接
      forkBtn.href = `https://github.com/${OWNER}/${REPO}/fork`;

      const h=location.hash||''; if(!h.startsWith('#submission=')){
        summaryEl.textContent='无提交数据 / No submission payload. 可点击“自动粘贴密文”从剪贴板填入。';
        // 手动流：允许从剪贴板填入 slim v3 JSON 并解析路径/元数据
        pasteBtn.addEventListener('click', async ()=>{
          try{
            const txt = await navigator.clipboard.readText();
            if(!txt){ alert('剪贴板为空'); return; }
            codeEl.value = txt;
            try{
              const slim = JSON.parse(txt);
              if(slim && slim.version===3 && slim.enc && slim.key){
                const metaBytes = xorBytes(fromHex(slim.enc), fromHex(slim.key));
                const metaStr = new TextDecoder().decode(metaBytes);
                const meta = JSON.parse(metaStr||'{}');
                const weekLocal = parseWeek(slim.challenge)||1;
                const displayHandle = meta.handle || 'anon';
                const safeHandle = toPathHandle(displayHandle);
                // 展示元数据与路径
                metaEl.textContent = `校验通过：bytes=${meta.bytes}, handle=${displayHandle}, ts=${meta.ts}`;
                const fullPath = `submissions/${weekLocal}/${safeHandle}/solution.c`;
                pathInfoEl.innerHTML = `目录名将使用：<code>${fullPath}</code>（兼容旧路径 submissions/week-${weekLocal}/） <span style="margin-left:6px;color:#8aa3b7">当前昵称：<code>${displayHandle}</code></span>`;
                openGhBtn.href = `https://github.com/${OWNER}/${REPO}/new/main/${encodeURIComponent(`submissions/${weekLocal}/${safeHandle}`)}?filename=solution.c`;
                summaryEl.textContent = `选手 ${displayHandle} · 题目 ${slim.challenge}`;
              } else {
                metaEl.textContent = '解析失败：不是有效的 v3 密文 JSON。';
              }
            }catch(_){ metaEl.textContent = '解析失败：请确认内容为 JSON。'; }
          }catch(_){ alert('无法读取剪贴板，请手动粘贴。'); }
        });
        // 复制按钮（无论是否有 payload）
        copyBtnCode.addEventListener('click',()=>{
          navigator.clipboard.writeText(codeEl.value).then(()=>{
            copyBtnCode.innerHTML='<i class="fas fa-check"></i> 已复制 Copied';
            setTimeout(()=>{ copyBtnCode.innerHTML='<i class="fas fa-copy"></i> 复制密文 Copy Encrypted'; }, 1200);
          });
        });
        return;
      }
      try{
    const obj=JSON.parse(decodeBase64(h.slice('#submission='.length))||'{}');
    const week=parseWeek(obj.challenge)||1;
    // 初始 handle（兼容旧版本 payload），显示与路径分开：显示尽量用原始，路径用安全化
    let displayHandle = obj.handle || 'anon';
    let safeHandle = toPathHandle(displayHandle);
    // Fork 按钮指向固定仓库 fork 页面（已在上方设置，可再次确保）
    forkBtn.href=`https://github.com/${OWNER}/${REPO}/fork`;
    codeEl.value = obj.code||'';
        // 解密元数据（若存在），优先以解密出的 handle 覆盖显示与路径
        let meta = null;
        try{
          if(obj.version===4){
            // v4 AES-GCM + RSA-OAEP: 前端仅显示元数据，不展示代码
            const b64ToBytes = (b64)=>{ const bin=atob(b64); const u=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) u[i]=bin.charCodeAt(i); return u; };
            // 不解密（私钥仅在服务端/管理员环境），从 encBundle 中无法直接读取源码
            if(obj.encBundle && obj.iv && obj.keyWrap){
              // 元数据嵌入在服务端可解密的 bundle 中，这里仅显示占位
              metaEl.textContent = `v4 加密提交：AES-GCM + 公钥包裹。源码与元数据已加密。`;
              codeEl.value = '（v4：本页面不提供一键粘贴内容。请使用“Issue 提交”或管理员通道。）';
              codeEl.readOnly = true;
              copyBtnCode.style.display='none';
              openGhBtn.style.display='none';
              // Issue 链接构造仅包含加密字段
              function rebuildIssueLinkV4(){
                const weekLocal = parseWeek(obj.challenge)||1;
                const bodyLines = [];
                bodyLines.push(`# Round ${weekLocal} Submission (${safeHandle})`);
                bodyLines.push('');
                bodyLines.push(`Challenge: ${obj.challenge}`);
                bodyLines.push('');
                bodyLines.push('Encrypted Payload (v4):');
                bodyLines.push('```');
                bodyLines.push(`version: 4`);
                bodyLines.push(`alg: ${obj.alg||'aes-256-gcm'}`);
                bodyLines.push(`iv: ${obj.iv}`);
                bodyLines.push(`keyWrap: ${obj.keyWrap}`);
                bodyLines.push(`encBundle: ${obj.encBundle.substring(0,120)}... (length=${obj.encBundle.length})`);
                bodyLines.push('```');
                bodyLines.push('');
                bodyLines.push('> 提交说明: 若无法方便地 Fork + PR, 使用该 Issue 方式。管理员会解密并归档。');
                bodyLines.push('> 注意：明文代码不再展示，请勿在此粘贴明文。');
                let issueBody = bodyLines.join('\n');
                const issueTitle = `Round-${weekLocal} Submission ${safeHandle}`;
                if(encodeURIComponent(issueBody).length > 7000){
                  issueBody = issueBody.slice(0,6900) + '\n... (truncated)';
                }
                const issueUrl = `https://github.com/${OWNER}/${REPO}/issues/new?title=${encodeURIComponent(issueTitle)}&body=${encodeURIComponent(issueBody)}`;
                issueBtn.href=issueUrl;
              }
              rebuildIssueLinkV4();
              // 结束 v4 分支（路径仍基于 safeHandle）
            }
          } else if(obj.enc && obj.key){
            const metaBytes = xorBytes(fromHex(obj.enc), fromHex(obj.key));
            const metaStr = new TextDecoder().decode(metaBytes);
            meta = JSON.parse(metaStr||'{}');
            if(meta && meta.handle){ displayHandle = meta.handle; safeHandle = toPathHandle(meta.handle); }
            metaEl.textContent = `校验通过：bytes=${meta.bytes}, handle=${meta.handle}, ts=${meta.ts}`;
            // v3：展示需要粘贴到 solution.c 的密文 JSON 内容
            if(obj.version>=3){
              const slim = { type:'contest', version:3, challenge: obj.challenge, enc: obj.enc, encCode: obj.encCode, key: obj.key };
              codeEl.value = JSON.stringify(slim, null, 2);
              codeEl.readOnly = false;
      copyBtnCode.style.display='inline-flex';
      openGhBtn.style.display='inline-flex';
      copyBtnCode.innerHTML='<i class="fas fa-copy"></i> 复制密文 Copy Encrypted';
            }
          }
    }catch(e){ metaEl.textContent='元数据解析失败（非致命）'; }
        function rebuildIssueLink(){
          if(obj.version===4){ return; } // v4 分支单独处理
          if(!(obj.enc && obj.key && meta)) return;
          const weekLocal = parseWeek(obj.challenge)||1;
          const bodyLines = [];
          bodyLines.push(`# Round ${weekLocal} Submission (${safeHandle})`);
          bodyLines.push('');
          bodyLines.push(`Challenge: ${obj.challenge}`);
          bodyLines.push('');
          bodyLines.push('Encrypted Metadata:');
          bodyLines.push('```');
          bodyLines.push(`enc: ${obj.enc}`);
          bodyLines.push(`key: ${obj.key}`);
          bodyLines.push(`version: ${obj.version||'2'}`);
          bodyLines.push(`bytes: ${meta.bytes}`);
          bodyLines.push(`ts: ${meta.ts}`);
          bodyLines.push('```');
          bodyLines.push('');
          bodyLines.push('Code (C):');
          bodyLines.push('```c');
          bodyLines.push(obj.code||'');
          bodyLines.push('```');
          bodyLines.push('');
          bodyLines.push('> 提交说明: 若无法方便地 Fork + PR, 使用该 Issue 方式。管理员会验证并归档到 submissions/ 目录。');
          bodyLines.push('> 注意：明文代码不再展示，请勿在此粘贴明文。');
          let issueBody = bodyLines.join('\n');
          const issueTitle = `Round-${weekLocal} Submission ${safeHandle}`;
          const encodedBody = encodeURIComponent(issueBody);
          if(encodedBody.length > 7000){
            const shortLines = [];
            shortLines.push(`# Round ${weekLocal} Submission (${safeHandle})`);
            shortLines.push('');
            shortLines.push(`Challenge: ${obj.challenge}`);
            shortLines.push('');
            shortLines.push('Encrypted Metadata:');
            shortLines.push('```');
            shortLines.push(`enc: ${obj.enc}`);
            shortLines.push(`key: ${obj.key}`);
            shortLines.push(`version: ${obj.version||'2'}`);
            shortLines.push(`bytes: ${meta.bytes}`);
            shortLines.push(`ts: ${meta.ts}`);
            shortLines.push('```');
            shortLines.push('');
            shortLines.push('> 代码较长，出于链接长度限制，请在 Issue 页面打开后手动粘贴代码。');
            shortLines.push('> 注意：明文代码不再展示，请勿在此粘贴明文。');
            issueBody = shortLines.join('\n');
          }
          const issueUrl = `https://github.com/${OWNER}/${REPO}/issues/new?title=${encodeURIComponent(issueTitle)}&body=${encodeURIComponent(issueBody)}`;
          issueBtn.href=issueUrl;
        }
        // 现在根据最终的 safeHandle 生成“在 Fork 中建文件”的链接，并展示目录名预览
  const path=`submissions/${week}/${safeHandle}`;
        const ghNew=`https://github.com/${OWNER}/${REPO}/new/main/${encodeURIComponent(path)}?filename=solution.c`;
  openGhBtn.href=ghNew;
  const fullPath = `${path}/solution.c`;
        const same = displayHandle === safeHandle;
        const warn = [];
        if(!same){ warn.push('注意：昵称中包含路径不支持的字符或多余空白，已转换为安全目录名。'); }
        if(fullPath.length > 180){ warn.push('提示：路径较长，建议精简昵称以避免后续在部分平台、工具中出现兼容性问题。'); }
        const copyBtn = document.createElement('button');
        copyBtn.className='btn';
        copyBtn.style.marginLeft='8px';
        copyBtn.innerHTML='<i class="fas fa-copy"></i> 复制路径';
        copyBtn.addEventListener('click',()=>{
          navigator.clipboard.writeText(fullPath).then(()=>{
            copyBtn.innerHTML='<i class="fas fa-check"></i> 已复制';
            setTimeout(()=>{ copyBtn.innerHTML='<i class="fas fa-copy"></i> 复制路径'; }, 1200);
          });
        });
  pathInfoEl.innerHTML = `目录名将使用：<code>${fullPath}</code>` + (warn.length? ` <span style="color:#f59e0b">（${warn.join(' ')}）</span>`: '') + ` <span style="margin-left:6px;color:#8aa3b7">当前昵称：<code>${displayHandle}</code></span>`;
        pathInfoEl.appendChild(copyBtn);
        // 顶部摘要显示原始（未清洗）的 handle，符合用户预期
  summaryEl.textContent=`选手 ${displayHandle} · 题目 ${obj.challenge}`;
  // 构造 Issue 提交内容（标题与目录名保持一致，用 safeHandle）
  rebuildIssueLink();
        copyBtnCode.addEventListener('click',()=>{
          navigator.clipboard.writeText(document.getElementById('code').value).then(()=>{
            copyBtnCode.innerHTML='<i class="fas fa-check"></i> 已复制 Copied';
            setTimeout(()=>{ copyBtnCode.innerHTML='<i class=\"fas fa-copy\"></i> 复制密文 Copy Encrypted'; }, 1200);
          });
        });
        // 修改昵称入口：弹出简单对话框，仅更新 localStorage 并刷新自身（不改变已提交的加密数据）
        editBtn.addEventListener('click',()=>{
          const current = displayHandle;
          const next = prompt('修改昵称 / Edit Handle', current);
          if(next===null) return; // canceled
          const trimmed = next.trim();
          if(!trimmed){ alert('昵称不能为空'); return; }
          try{ localStorage.setItem('contest_profile', JSON.stringify({ handle: trimmed })); }catch(e){}
          // 更新展示（不改加密 payload，但下次提交会生效）
          displayHandle = trimmed; safeHandle = toPathHandle(trimmed);
          summaryEl.textContent=`选手 ${displayHandle} · 题目 ${obj.challenge}`;
          // 重建路径预览与“在 Fork 中建文件”链接
          const newDir = `submissions/${week}/${safeHandle}`;
          const newGhNew = `https://github.com/${OWNER}/${REPO}/new/main/${encodeURIComponent(newDir)}?filename=solution.c`;
          openGhBtn.href=newGhNew;
          const newPath = `${newDir}/solution.c`;
          pathInfoEl.innerHTML = `目录名将使用：<code>${newPath}</code> <span style=\"margin-left:6px;color:#8aa3b7\">当前昵称：<code>${displayHandle}</code></span>`;
          pathInfoEl.appendChild(copyBtn);
          // 重新生成加密元数据（仅用于 Issue 链接；不回传服务端）。
          try{
            if(obj.version===4){
              // v4 不在前端重建加密数据，仅重建 Issue 链接即可（需服务端解密）
              const weekLocal = parseWeek(obj.challenge)||1;
              const bodyLines = [];
              bodyLines.push(`# Round ${weekLocal} Submission (${safeHandle})`);
              bodyLines.push('');
              bodyLines.push(`Challenge: ${obj.challenge}`);
              bodyLines.push('');
              bodyLines.push('Encrypted Payload (v4):');
              bodyLines.push('```');
              bodyLines.push(`version: 4`);
              bodyLines.push(`alg: ${obj.alg||'aes-256-gcm'}`);
              bodyLines.push(`iv: ${obj.iv}`);
              bodyLines.push(`keyWrap: ${obj.keyWrap}`);
              bodyLines.push(`encBundle: ${obj.encBundle.substring(0,120)}... (length=${obj.encBundle.length})`);
              bodyLines.push('```');
              bodyLines.push('');
              bodyLines.push('> 提交说明: 若无法方便地 Fork + PR, 使用该 Issue 方式。管理员会解密并归档。');
              bodyLines.push('> 注意：明文代码不再展示，请勿在此粘贴明文。');
              let issueBody = bodyLines.join('\n');
              const issueTitle = `Round-${weekLocal} Submission ${safeHandle}`;
              if(encodeURIComponent(issueBody).length > 7000){ issueBody = issueBody.slice(0,6900)+'\n... (truncated)'; }
              const issueUrl = `https://github.com/${OWNER}/${REPO}/issues/new?title=${encodeURIComponent(issueTitle)}&body=${encodeURIComponent(issueBody)}`;
              issueBtn.href=issueUrl;
              return;
            }
            const bytes = (meta && typeof meta.bytes==='number')? meta.bytes : new TextEncoder().encode(obj.code||'').length;
            const metaStr = JSON.stringify({ handle: displayHandle, challenge: obj.challenge, bytes, ts: new Date().toISOString() });
            const keyHex = obj.key||''; const keyBytes = fromHex(keyHex);
            const encBytes = xorBytes(new TextEncoder().encode(metaStr), keyBytes);
            obj.enc = toHex(encBytes); // 保持原 key 不变，确保 encCode 可用
            meta = JSON.parse(metaStr);
            // 更新元数据显示
            metaEl.textContent = `校验通过：bytes=${meta.bytes}, handle=${meta.handle}, ts=${meta.ts}`;
          }catch(_){ /* ignore */ }
          // 重建 Issue 链接
          rebuildIssueLink();
        });
      }catch(e){ document.getElementById('summary').textContent='解析失败 / Parse failed'; }
    })();
  </script>
</body>
</html>
